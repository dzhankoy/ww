<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>WW Poker TV</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-1: #05070b;
            --bg-2: #0d121a;
            --panel: #111723;
            --panel-strong: #171f2e;
            --card: #151c28;
            --card-border: #222c3d;
            --avatar-border: rgba(255, 255, 255, 0.06);
            --header-accent-start: rgba(255, 214, 10, 0.12);
            --header-accent-end: rgba(21, 28, 40, 0.92);
            --header-accent-border: rgba(255, 214, 10, 0.25);
            --accent: #ffd60a;
            --blinds-time-accent: var(--accent);
            --green: #32d74b;
            --red: #ff453a;
            --blue: #0a84ff;
            --text: #f5f7fb;
            --muted: #9aa4b2;
            --shadow: 0 24px 60px rgba(0, 0, 0, 0.35);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            background: radial-gradient(circle at 20% 20%, rgba(10, 132, 255, 0.18), transparent 50%),
                radial-gradient(circle at 80% 10%, rgba(255, 214, 10, 0.2), transparent 40%),
                linear-gradient(160deg, var(--bg-1), var(--bg-2));
            font-family: 'Manrope', system-ui, sans-serif;
            color: var(--text);
            font-variant-numeric: tabular-nums;
            font-feature-settings: "tnum" 1, "lnum" 1;
        }

        .tv-app {
            padding: 36px 52px 48px;
            display: flex;
            flex-direction: column;
            gap: 28px;
        }

        .tv-header {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .header-top,
        .header-bottom {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            gap: 24px;
        }

        .header-top {
            padding: 16px 20px;
        }

        .header-bottom {
            padding: 16px 20px;
            border-radius: 20px;
            background: linear-gradient(140deg, var(--header-accent-start), var(--header-accent-end));
            border: 1px solid var(--header-accent-border);
            box-shadow: var(--shadow);
        }

        .logo-block {
            display: flex;
            align-items: center;
            gap: 18px;
        }

        .header-title {
            text-align: center;
        }

        .header-block {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .header-block.align-left {
            align-items: flex-start;
            text-align: left;
        }

        .header-block.align-right {
            align-items: flex-end;
            text-align: right;
        }

        .header-label {
            font-size: 12px;
            letter-spacing: 0.14em;
            text-transform: uppercase;
            color: var(--muted);
        }

        .header-value {
            margin-top: 6px;
            font-size: 28px;
            font-weight: 700;
        }

        .header-clock {
            font-size: 86px;
            font-weight: 800;
            color: var(--accent);
            line-height: 1;
        }

        .clock-sep {
            display: inline-block;
            width: 0.6ch;
            text-align: center;
            animation: clockBlink 1s steps(1) infinite;
        }

        .clock-sep-static {
            display: inline-block;
            width: 0.6ch;
            text-align: center;
        }

        @keyframes clockBlink {
            0%, 49% {
                opacity: 1;
            }
            50%, 100% {
                opacity: 0;
            }
        }


        .header-comment {
            margin-top: 6px;
            font-size: 13px;
            color: var(--muted);
        }

        .header-comment.is-alert {
            color: var(--red);
        }

        .club-logo {
            width: 68px;
            height: 68px;
            border-radius: 16px;
            object-fit: cover;
            box-shadow: var(--shadow);
            background: #0b0f14;
        }

        .club-name {
            font-size: 32px;
            font-weight: 800;
            color: var(--text);
        }

        .tournament-name {
            font-size: 32px;
            font-weight: 800;
        }

        .current-time {
            font-size: 32px;
            font-weight: 800;
        }

        .tournament-status {
            font-size: 14px;
            color: var(--muted);
            margin-top: 6px;
            display: none;
        }

        .stat-card.is-hidden {
            display: none;
        }

        .app-version {
            letter-spacing: 0.08em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 18px;
        }

        .stat-card {
            background: var(--panel);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 16px 18px;
            box-shadow: var(--shadow);
        }

        .stat-card.has-progress {
            position: relative;
            overflow: hidden;
            --stat-progress: 0%;
        }

        .stat-card.has-progress::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(
                90deg,
                rgba(40, 167, 69, 0.18) 0%,
                rgba(40, 167, 69, 0.18) var(--stat-progress),
                rgba(0, 0, 0, 0) var(--stat-progress),
                rgba(0, 0, 0, 0) 100%
            );
            pointer-events: none;
        }

        .stat-card > * {
            position: relative;
        }


        .stat-label {
            font-size: 13px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.12em;
        }

        .stat-value {
            margin-top: 10px;
            font-size: 32px;
            font-weight: 800;
        }

        .stat-sub {
            margin-top: 6px;
            font-size: 14px;
            color: var(--muted);
        }

        #statBlinds,
        #tournamentClock {
            color: var(--blinds-time-accent);
        }

        .tables-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 18px;
        }

        .table-card {
            background: var(--card);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            padding: 18px;
            display: flex;
            flex-direction: column;
            gap: 14px;
            min-height: 220px;
        }

        .table-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .table-number {
            font-size: 32px;
            font-weight: 800;
        }

        .table-count {
            font-size: 32px;
            font-weight: 800;
        }

        .players-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .player-chip {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            width: 76px;
        }

        .player-avatar {
            position: relative;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: 1px solid var(--avatar-border);
            background: #0b0f14;
        }

        .player-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .player-name {
            font-size: 11px;
            color: var(--muted);
            text-align: center;
            max-width: 80px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-knockouts {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 2px;
            min-height: 26px;
        }

        .player-knockouts:empty {
            display: none;
        }

        .ko-avatar {
            position: relative;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            overflow: hidden;
            border: 1px solid var(--avatar-border);
            background: #0b0f14;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.22);
        }

        .ko-avatar + .ko-avatar {
            margin-left: -10px;
        }

        .ko-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: grayscale(1);
            opacity: 0.55;
        }

        .ko-avatar::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            width: 150%;
            height: 2px;
            background: rgba(255, 69, 58, 0.95);
            transform: translate(-50%, -50%) rotate(-18deg);
            box-shadow: 0 0 8px rgba(255, 69, 58, 0.35);
        }

        .player-chip.out .player-avatar img {
            filter: grayscale(1);
            opacity: 0.45;
        }

        .player-chip.out .player-avatar::before,
        .player-chip.out .player-avatar::after {
            content: '';
            position: absolute;
            left: -10px;
            top: 50%;
            width: 86px;
            height: 4px;
            background: repeating-linear-gradient(90deg, rgba(255, 69, 58, 0.95) 0 10px, rgba(255, 69, 58, 0.7) 10px 16px);
            border-radius: 999px;
            transform-origin: center;
            z-index: 4;
            box-shadow: 0 0 10px rgba(255, 69, 58, 0.4);
            filter: blur(0.2px);
        }

        .player-chip.out .player-avatar::before {
            transform: translateY(-50%) rotate(36deg) skewX(-8deg);
        }

        .player-chip.out .player-avatar::after {
            transform: translateY(-50%) rotate(-34deg) skewX(6deg);
        }

        .role-badge {
            position: absolute;
            right: 0;
            bottom: 0;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            color: #fff;
            border: 2px solid var(--card);
            z-index: 5;
        }

        .role-badge.dealer {
            background: var(--blue);
            right: -2px;
            bottom: -2px;
        }

        .role-badge.admin {
            background: var(--accent);
            color: #1b1b1b;
            top: 0;
            left: 50%;
            right: auto;
            bottom: auto;
            transform: translate(-50%, -50%);
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--muted);
        }

        @media (max-width: 1200px) {
            .tv-app {
                padding: 28px 24px 36px;
            }
            .tournament-name {
                font-size: 28px;
            }
            .header-clock {
                font-size: 59px;
            }
            .table-card {
                min-height: 180px;
            }
            .header-top,
            .header-bottom {
                grid-template-columns: 1fr;
                text-align: left;
            }
            .header-title {
                text-align: left;
            }
            .header-block,
            .header-block.align-right {
                align-items: flex-start;
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <div class="tv-app">
        <header class="tv-header">
            <div class="header-top">
                <div class="logo-block">
                    <img src="logo.png" alt="WW" class="club-logo">
                    <div>
                        <div class="club-name">Wild West Poker</div>
                        <div class="header-comment">Тула, Тургеневская, 7</div>
                    </div>
                </div>
                <div class="header-title">
                    <div class="tournament-name" id="tournamentName">Турнир</div>
                    <div class="header-comment" id="tournamentStart">дата и время старта —</div>
                </div>
                <div class="header-block align-right">
                    <div class="tournament-name" id="currentTime">--:--</div>
                    <div class="header-comment app-version" id="appVersion"></div>
                    <div class="tournament-status" id="tournamentStatus">Статус: —</div>
                </div>
            </div>
            <div class="header-bottom">
                <div class="header-block align-left">
                    <div class="header-label">Блайнды</div>
                    <div class="header-clock" id="statBlinds">20/50</div>
                    <div class="header-comment" id="statBlindsSub">уровень 2</div>
                </div>
                <div class="header-block">
                    <div class="header-label">Время турнира</div>
                    <div class="header-clock" id="tournamentClock">—</div>
                    <div class="header-comment is-alert" id="breakComment">до перерыва —</div>
                </div>
                <div class="header-block align-right">
                    <div class="header-label">Повышение</div>
                    <div class="header-clock" id="statNextBlind">50/100</div>
                    <div class="header-comment" id="statNextBlindSub">следующий уровень 3</div>
                </div>
            </div>
        </header>

        <section class="stats-grid">
            <div class="stat-card has-progress" id="statPlayersCard">
                <div class="stat-label">Игроки</div>
                <div class="stat-value" id="statPlayers">—</div>
                <div class="stat-sub" id="statPlayersSub">активных —, вылетело —</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Столы</div>
                <div class="stat-value" id="statTables">—</div>
                <div class="stat-sub" id="statTablesSub">активные —</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Ребаи</div>
                <div class="stat-value" id="statRebuys">—</div>
                <div class="stat-sub" id="statRebuysSub">входов —</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Средний стек</div>
                <div class="stat-value" id="statAvgStack">—</div>
                <div class="stat-sub" id="statAvgStackSub">начальный стек —</div>
            </div>
            <div class="stat-card is-hidden">
                <div class="stat-label">Контроль</div>
                <div class="stat-value" id="statAdmins">—</div>
                <div class="stat-sub" id="statAdminsSub">админов —, вызовов —</div>
            </div>
        </section>

        <section class="tables-grid" id="tablesGrid"></section>
    </div>

    <script>
        const CONFIG = {
            TOURNAMENT_API_URL: 'https://5970995-zo35356.twc1.net/webhook/tournament',
            PHOTOS_BASE_URL: 'https://5970995-zo35356.twc1.net/pictures',
            PHOTOS_VERSION: 4,
            REFRESH_INTERVAL: 30000,
            REQUEST_TIMEOUT: 10000,
            MAX_REBUYS: 3
        };

        const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;

        const state = {
            fullData: null,
            startDate: null,
            nextBlindAt: null,
            failedPhotos: new Set()
        };

        const tournamentNameEl = document.getElementById('tournamentName');
        const currentTimeEl = document.getElementById('currentTime');
        const tournamentClockEl = document.getElementById('tournamentClock');
        const tournamentStatusEl = document.getElementById('tournamentStatus');
        const appVersionEl = document.getElementById('appVersion');
        const tournamentStartEl = document.getElementById('tournamentStart');
        const breakCommentEl = document.getElementById('breakComment');
        const statPlayersEl = document.getElementById('statPlayers');
        const statPlayersSubEl = document.getElementById('statPlayersSub');
        const statPlayersCardEl = document.getElementById('statPlayersCard');
        const statTablesEl = document.getElementById('statTables');
        const statTablesSubEl = document.getElementById('statTablesSub');
        const statBlindsEl = document.getElementById('statBlinds');
        const statBlindsSubEl = document.getElementById('statBlindsSub');
        const statNextBlindEl = document.getElementById('statNextBlind');
        const statNextBlindSubEl = document.getElementById('statNextBlindSub');
        const statRebuysEl = document.getElementById('statRebuys');
        const statRebuysSubEl = document.getElementById('statRebuysSub');
        const statAvgStackEl = document.getElementById('statAvgStack');
        const statAvgStackSubEl = document.getElementById('statAvgStackSub');
        const statAdminsEl = document.getElementById('statAdmins');
        const statAdminsSubEl = document.getElementById('statAdminsSub');
        const tablesGridEl = document.getElementById('tablesGrid');

        function applyTelegramTheme() {
            const root = document.documentElement;
            const themeParams = tg?.themeParams || {};
            const colorScheme = tg?.colorScheme || (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');

            if (colorScheme === 'light') {
                root.style.setProperty('--bg-1', themeParams.bg_color || '#f7f7fb');
                root.style.setProperty('--bg-2', themeParams.secondary_bg_color || '#e9edf5');
                root.style.setProperty('--panel', themeParams.secondary_bg_color || '#ffffff');
                root.style.setProperty('--panel-strong', themeParams.secondary_bg_color || '#f4f6fb');
                root.style.setProperty('--card', themeParams.secondary_bg_color || '#ffffff');
                root.style.setProperty('--card-border', '#d6dbe6');
                root.style.setProperty('--avatar-border', 'rgba(0, 0, 0, 0.08)');
                root.style.setProperty('--text', themeParams.text_color || '#0c1118');
                root.style.setProperty('--muted', themeParams.hint_color || '#6c7684');
                root.style.setProperty('--accent', '#f0b90b');
                root.style.setProperty('--blinds-time-accent', '#ff453a');
                root.style.setProperty('--header-accent-start', 'rgba(240, 185, 11, 0.12)');
                root.style.setProperty('--header-accent-end', 'rgba(255, 255, 255, 0.92)');
                root.style.setProperty('--header-accent-border', 'rgba(0, 0, 0, 0.08)');
            } else {
                root.style.setProperty('--bg-1', themeParams.bg_color || '#05070b');
                root.style.setProperty('--bg-2', themeParams.secondary_bg_color || '#0d121a');
                root.style.setProperty('--panel', themeParams.secondary_bg_color || '#111723');
                root.style.setProperty('--panel-strong', '#171f2e');
                root.style.setProperty('--card', '#151c28');
                root.style.setProperty('--card-border', '#222c3d');
                root.style.setProperty('--avatar-border', 'rgba(255, 255, 255, 0.06)');
                root.style.setProperty('--text', themeParams.text_color || '#f5f7fb');
                root.style.setProperty('--muted', themeParams.hint_color || '#9aa4b2');
                root.style.setProperty('--accent', '#ffd60a');
                root.style.setProperty('--blinds-time-accent', '#ffd60a');
                root.style.setProperty('--header-accent-start', 'rgba(255, 214, 10, 0.12)');
                root.style.setProperty('--header-accent-end', 'rgba(21, 28, 40, 0.92)');
                root.style.setProperty('--header-accent-border', 'rgba(255, 214, 10, 0.25)');
            }
        }

        function getTournament() {
            return state.fullData?.tournament || {};
        }

        function pad2(value) {
            return String(value).padStart(2, '0');
        }

        function formatClockHtml(parts) {
            return parts.map((part, index) => {
                const chunk = pad2(part);
                return index === 0 ? chunk : `<span class="clock-sep">:</span>${chunk}`;
            }).join('');
        }

        function formatClockHtmlStatic(parts) {
            return parts.map((part, index) => {
                const chunk = pad2(part);
                return index === 0 ? chunk : `<span class="clock-sep-static">:</span>${chunk}`;
            }).join('');
        }

        function formatClockText(parts) {
            return parts.map(pad2).join(':');
        }

        function formatHHMMSSParts(ms) {
            const totalSeconds = Math.max(0, Math.floor(ms / 1000));
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return [hours, minutes, seconds];
        }

        function formatTimeHMParts(date) {
            return [date.getHours(), date.getMinutes()];
        }

        function getPlayerPhotoUrl(id) {
            if (!id) return 'avatar.png';
            if (state.failedPhotos.has(id)) return 'avatar.png';
            return `${CONFIG.PHOTOS_BASE_URL}/${id}.jpg?v=${CONFIG.PHOTOS_VERSION}`;
        }

        function handlePlayerPhotoError(event) {
            const img = event?.target;
            if (!img) return;
            const id = Number(img.dataset.playerId);
            if (Number.isFinite(id)) {
                state.failedPhotos.add(id);
            }
            img.src = 'avatar.png';
            img.onerror = null;
        }

        function parseDateFromTournament(t) {
            if (!t?.date || !t?.time) return null;
            try {
                const [day, month, year] = String(t.date).split('.');
                const [hours, minutes] = String(t.time).split(':');
                const dt = new Date(Number(year), Number(month) - 1, Number(day), Number(hours), Number(minutes), 0, 0);
                return isNaN(dt.getTime()) ? null : dt;
            } catch (e) {
                return null;
            }
        }

        function parseDateTimeValue(value, t) {
            if (!value) return null;
            if (value instanceof Date) return isNaN(value.getTime()) ? null : value;
            if (typeof value === 'number') {
                const dt = new Date(value);
                return isNaN(dt.getTime()) ? null : dt;
            }
            const str = String(value).trim();
            if (!str) return null;
            const direct = new Date(str);
            if (!isNaN(direct.getTime())) return direct;
            if (t?.date && /^\d{1,2}:\d{2}$/.test(str)) {
                const [hours, minutes] = str.split(':');
                const [day, month, year] = String(t.date).split('.');
                const dt = new Date(Number(year), Number(month) - 1, Number(day), Number(hours), Number(minutes), 0, 0);
                return isNaN(dt.getTime()) ? null : dt;
            }
            return null;
        }

        function getNextBlindDate(t) {
            const candidates = [
                t.blinds_next_at,
                t.next_blind_time,
                t.nextBlindTime,
                t.blindUpAt,
                t.blindsUpAt,
                t.level_end_time,
                t.levelEndTime,
                t.next_level_time,
                t.nextLevelTime
            ];
            for (const candidate of candidates) {
                const dt = parseDateTimeValue(candidate, t);
                if (dt) return dt;
            }
            return null;
        }

        function getBlindsText(t) {
            if (t.small_blind && t.big_blind) {
                const ante = t.ante ? ` (${t.ante})` : '';
                return `${t.small_blind}/${t.big_blind}${ante}`;
            }
            if (t.blinds) return String(t.blinds);
            if (t.blind) return String(t.blind);
            return '—';
        }

        function computeStats(tables, t) {
            let totalPlayers = 0;
            let activePlayers = 0;
            let outPlayers = 0;
            let totalRebuys = 0;

            tables.forEach(table => {
                const players = Array.isArray(table.players) ? table.players : [];
                totalPlayers += players.length;
                activePlayers += players.filter(p => p && !p.outTime).length;
                outPlayers += players.filter(p => p && !!p.outTime).length;
                players.forEach(p => {
                    if (typeof p.rebuysLeft === 'number') {
                        const used = CONFIG.MAX_REBUYS - p.rebuysLeft;
                        if (used > 0) totalRebuys += used;
                    }
                });
            });

            const stackNumber = (t && t.stack !== undefined && t.stack !== null && String(t.stack).trim() !== '')
                ? Number(t.stack)
                : NaN;
            const totalEntries = totalPlayers + totalRebuys;
            const avgStack = (Number.isFinite(stackNumber) && activePlayers > 0)
                ? Math.round((totalEntries * stackNumber) / activePlayers)
                : null;

            return { totalPlayers, activePlayers, outPlayers, totalRebuys, totalEntries, avgStack };
        }

        function renderTables(tables, adminsList) {
            if (!tablesGridEl) return;
            tablesGridEl.innerHTML = `
                <div class="table-card">
                    <div class="empty-state">Нет данных о столах</div>
                </div>
            `;
            let imgs = tablesGridEl.querySelectorAll('img[data-player-id]');
            imgs.forEach(img => img.addEventListener('error', handlePlayerPhotoError, { once: true }));
            if (!tables.length) {
                return;
            }

            const knockedOutById = new Map();
            tables.forEach(table => {
                const players = Array.isArray(table?.players) ? table.players : [];
                players.forEach(p => {
                    if (!p || !p.outTime || p.id == null) return;
                    const rawKillerId = p.outByChatId ?? p.out_by_chat_id ?? p.outById ?? p.out_by_id ?? p.outByPlayerId ?? p.out_by_player_id;
                    if (rawKillerId == null || rawKillerId === '') return;
                    const killerKey = String(rawKillerId);
                    if (!knockedOutById.has(killerKey)) knockedOutById.set(killerKey, new Set());
                    knockedOutById.get(killerKey).add(p.id);
                });
            });

            tablesGridEl.innerHTML = tables.map(table => {
                const players = Array.isArray(table.players) ? table.players : [];
                const activeCount = players.filter(p => p && !p.outTime).length;
                const maxCount = players.length || 0;

                const playersHtml = players.map(p => {
                    const nickname = String(p?.nickname || p?.firstName || 'Игрок').trim();
                    const isOut = !!p?.outTime;
                    const isDealer = p?.dealer === true;
                    const isAdmin = p?.isAdmin === true || p?.is_admin === true || (adminsList || []).some(id => String(id) === String(p?.id));

                    const knockedSet = (p?.id != null) ? knockedOutById.get(String(p.id)) : null;
                    const knockedIds = knockedSet ? Array.from(knockedSet) : [];
                    const knockedHtml = knockedIds.slice(0, 8).map(pid => {
                        return `<div class="ko-avatar"><img src="${getPlayerPhotoUrl(pid)}" alt="" data-player-id="${pid}"></div>`;
                    }).join('');

                    return `
                        <div class="player-chip${isOut ? ' out' : ''}">
                            <div class="player-avatar">
                                <img src="${getPlayerPhotoUrl(p?.id)}" alt="" data-player-id="${p?.id || ''}">
                                ${isAdmin ? '<span class="role-badge admin">A</span>' : ''}
                                ${isDealer ? '<span class="role-badge dealer">D</span>' : ''}
                            </div>
                            <div class="player-name">${nickname}</div>
                            <div class="player-knockouts">${knockedHtml}</div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="table-card">
                        <div class="table-header">
                            <div class="table-number">Стол ${table.id || '—'}</div>
                            <div class="table-count">${activeCount} игроков</div>
                        </div>
                        <div class="players-row">${playersHtml}</div>
                    </div>
                `;
            }).join('');

            imgs = tablesGridEl.querySelectorAll('img[data-player-id]');
            imgs.forEach(img => img.addEventListener('error', handlePlayerPhotoError, { once: true }));
        }

        function updateStats() {
            const t = getTournament();
            const tables = Array.isArray(t.tables) ? t.tables : [];
            const stats = computeStats(tables, t);
            const activeTables = tables.filter(table => (Array.isArray(table.players) ? table.players : []).some(p => p && !p.outTime)).length;
            const adminCallsCount = Array.isArray(t.adminCalls) ? t.adminCalls.length : 0;
            const adminsCount = Array.isArray(t.admins) ? t.admins.length : 0;

            tournamentNameEl.textContent = t.title || t.name || 'Турнир';
            tournamentStatusEl.textContent = `Статус: ${String(t.status || '—').toUpperCase()}`;
            if (tournamentStartEl) {
                const startDate = t.date ? String(t.date).trim() : '';
                const startTime = t.time ? String(t.time).trim() : '';
                tournamentStartEl.textContent = startDate || startTime
                    ? `${startDate} ${startTime}`.trim()
                    : 'дата и время старта —';
            }
            if (breakCommentEl) {
                breakCommentEl.textContent = 'до перерыва 01:30:00';
            }

            statPlayersEl.textContent = stats.activePlayers;
            statPlayersSubEl.textContent = `активных ${stats.activePlayers}, вылетело ${stats.outPlayers}`;
            if (statPlayersCardEl) {
                const ratio = stats.totalPlayers > 0 ? (stats.activePlayers / stats.totalPlayers) : 0;
                const safeRatio = Number.isFinite(ratio) ? Math.max(0, Math.min(1, ratio)) : 0;
                statPlayersCardEl.style.setProperty('--stat-progress', `${safeRatio * 100}%`);
            }

            statTablesEl.textContent = activeTables;
            statTablesSubEl.textContent = `активных ${activeTables}`;

            const blindsText = getBlindsText(t);
            statBlindsEl.textContent = blindsText !== '—' ? blindsText : '20/50';
            statBlindsSubEl.textContent = t.level ? `уровень ${t.level}` : 'уровень 2';

            statNextBlindEl.textContent = t.next_blinds
                ? String(t.next_blinds)
                : '50/100';
            statNextBlindSubEl.textContent = t.next_level
                ? `следующий уровень ${t.next_level}`
                : 'следующий уровень 3';

            statRebuysEl.textContent = stats.totalRebuys;
            statRebuysSubEl.textContent = `входов ${stats.totalEntries}`;

            const initialStack = (t.stack !== null && t.stack !== undefined && String(t.stack).trim() !== '')
                ? String(t.stack)
                : '7000';
            statAvgStackEl.textContent = stats.avgStack ?? '—';
            statAvgStackSubEl.textContent = `начальный стек ${initialStack}`;

            statAdminsEl.textContent = adminsCount;
            statAdminsSubEl.textContent = `админов ${adminsCount}, вызовов ${adminCallsCount}`;

            if (!state.startDate) {
                state.startDate = parseDateFromTournament(t);
            }
            state.nextBlindAt = getNextBlindDate(t);

            renderTables(tables, t.admins || []);
        }

        function updateClock() {
            const now = new Date();
            currentTimeEl.innerHTML = formatClockHtml(formatTimeHMParts(now));

            if (state.startDate) {
                const diffMs = now - state.startDate;
                if (diffMs >= 0) {
                    tournamentClockEl.innerHTML = formatClockHtmlStatic(formatHHMMSSParts(diffMs));
                } else {
                    tournamentClockEl.innerHTML = formatClockHtmlStatic(formatHHMMSSParts(-diffMs));
                }
            } else {
                tournamentClockEl.textContent = '—';
            }

            if (state.nextBlindAt) {
                const diffMs = state.nextBlindAt - now;
                statNextBlindSubEl.textContent = diffMs >= 0
                    ? `следующий уровень через ${formatClockText(formatHHMMSSParts(diffMs))}`
                    : statNextBlindSubEl.textContent;
            }
        }

        async function fetchTournamentData() {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), CONFIG.REQUEST_TIMEOUT);

            const response = await fetch(CONFIG.TOURNAMENT_API_URL, {
                method: 'GET',
                signal: controller.signal,
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            });

            clearTimeout(timeoutId);

            if (!response.ok) {
                throw new Error(`HTTP error ${response.status}`);
            }

            const responseData = await response.json();
            const fullData = Array.isArray(responseData) && responseData.length > 0 ? responseData[0] : responseData;
            if (!fullData || typeof fullData !== 'object') return { tournament: { tables: [] } };

            if (!fullData.tournament || typeof fullData.tournament !== 'object') {
                fullData.tournament = { tables: [] };
            }
            if (!Array.isArray(fullData.tournament.tables)) {
                fullData.tournament.tables = [];
            }
            if (!Array.isArray(fullData.tournament.admins)) {
                fullData.tournament.admins = [];
            }

            return fullData;
        }

        async function loadTournamentData() {
            try {
                state.fullData = await fetchTournamentData();
                updateStats();
                updateClock();
            } catch (error) {
                tournamentStatusEl.textContent = 'Статус: ошибка загрузки';
            }
        }

        function init() {
            applyTelegramTheme();
            if (tg && typeof tg.onEvent === 'function') {
                tg.onEvent('themeChanged', applyTelegramTheme);
            }
            if (appVersionEl) {
                appVersionEl.textContent = `TV v${TV_APP_VERSION_TOTAL} • ${TV_HTML_LAST_EDITED}`;
            }
            loadTournamentData();
            updateClock();
            setInterval(updateClock, 1000);
            setInterval(loadTournamentData, CONFIG.REFRESH_INTERVAL);
        }

        // Запускаем приложение
        var TV_APP_VERSION_MAJOR = 0;
        var TV_APP_VERSION_MINOR = 1;
        var TV_APP_VERSION_PATCH = 36;
        var TV_APP_VERSION_TOTAL = `${TV_APP_VERSION_MAJOR}.${TV_APP_VERSION_MINOR}.${TV_APP_VERSION_PATCH}`;
        var TV_HTML_LAST_EDITED = '30.01.26 18:32';

        init();
    </script>
</body>
</html>
